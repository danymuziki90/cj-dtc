generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


enum Role {
  ADMIN
  STUDENT
}

enum StudentStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

model Student {
  id            String        @id @default(cuid())
  firstName     String
  lastName      String
  email         String        @unique
  password      String
  phone         String?
  studentNumber String        @unique
  status        StudentStatus @default(PENDING)
  role          Role          @default(STUDENT)
  
  // Additional fields from registration form
  dateOfBirth   DateTime?
  address       String?
  city          String?
  country      String?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  passwordResetTokens PasswordResetToken[]
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          Role      @default(STUDENT)
  createdAt     DateTime  @default(now())
  accounts      Account[]
  sessions      Session[]
  certificates  Certificate[]
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String  @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([studentId])
}

model Formation {
  id            Int      @id @default(autoincrement())
  title         String
  slug          String   @unique
  description   String
  objectifs     String?
  duree         String?
  modules       String?
  methodes      String?
  certification String?
  categorie     String?
  statut        String   @default("brouillon") // brouillon, publie, archive
  imageUrl      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  certificates  Certificate[]
  enrollments   Enrollment[]
  sessions      TrainingSession[]
  documents     Document[]
  evaluations   Evaluation[]
  assignments    Assignment[]
}

model Article {
  id        Int      @id @default(autoincrement())
  title     String
  slug      String   @unique
  excerpt   String?
  content   String
  imageUrl  String?
  published Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Certificate {
  id         Int      @id @default(autoincrement())
  code       String   @unique
  type       String   @default("completion") // completion, attendance, excellence
  holderName String
  formation   Formation? @relation(fields: [formationId], references: [id])
  formationId Int?
  sessionId  Int?
  session    TrainingSession? @relation(fields: [sessionId], references: [id])
  enrollmentId Int?   @unique
  enrollment Enrollment? @relation(fields: [enrollmentId], references: [id])
  issuedAt   DateTime @default(now())
  verified   Boolean  @default(false)
  issuedBy   String?
  user       User?    @relation(fields: [userId], references: [id])
  userId     String?

  @@index([formationId])
  @@index([sessionId])
  @@index([enrollmentId])
  @@index([type])
}

model LMSConfig {
  id        Int     @id @default(autoincrement())
  provider  String
  apiUrl    String?
  apiKey    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Enrollment {
  id                  Int      @id @default(autoincrement())
  firstName           String
  lastName            String
  email               String
  phone               String?
  address             String?
  matricule           String?  @unique
  formationId         Int
  formation           Formation @relation(fields: [formationId], references: [id], onDelete: Cascade)
  sessionId           Int?
  session             TrainingSession? @relation(fields: [sessionId], references: [id])
  startDate           DateTime
  status              String   @default("pending") // pending, accepted, confirmed, rejected, cancelled, completed
  motivationLetter    String?
  notes               String?

  // Suivi des paiements
  paymentStatus       String   @default("unpaid") // unpaid, partial, paid
  totalAmount         Float    @default(0)
  paidAmount          Float    @default(0)
  paymentMethod       String?  // card, bank_transfer, check, cash
  paymentDate         DateTime?
  invoiceNumber       String?  @unique
  
  // Relations
  payments            Payment[]
  invoices            Invoice[]
  waitlist            Waitlist[]
  attendances         Attendance[]

  // Certificats
  certificateIssued   Boolean  @default(false)
  certificateId       Int?     @unique
  certificate         Certificate?

  // Évaluations
  evaluation          Evaluation?

  // Relances automatiques
  lastReminderSent    DateTime?
  reminderCount       Int      @default(0)
  nextReminderDate    DateTime?

  // Analytics et suivi
  source              String?  // website, social_media, referral, search_engine, advertisement, other
  sourceDetails       String?  // détails supplémentaires sur l'origine
  employmentStatus    String?  // employed, unemployed, student, self_employed, other
  insertionResult     String?  // placed, not_placed, pending (pour le suivi d'insertion professionnelle)
  insertionDate       DateTime?
  insertionNotes      String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([formationId])
  @@index([sessionId])
  @@index([email])
  @@index([startDate])
  @@index([status])
  @@index([paymentStatus])
  @@index([source])
}

model TrainingSession {
  id                Int         @id @default(autoincrement())
  formationId       Int
  formation         Formation   @relation(fields: [formationId], references: [id], onDelete: Cascade)
  startDate         DateTime
  endDate           DateTime
  startTime         String
  endTime           String
  location          String
  format            String      // presentiel, distanciel, hybride
  maxParticipants   Int         @default(25)
  currentParticipants Int       @default(0)
  price             Float       @default(0)
  status            String      @default("ouverte") // ouverte, fermee, complete, annulee, terminee
  description       String?
  prerequisites     String?
  objectives        String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  enrollments       Enrollment[]
  instructors       SessionInstructor[]
  documents         Document[]
  evaluations       Evaluation[]
  certificates      Certificate[]
  waitlist          Waitlist[]
  attendances       Attendance[]
  @@index([formationId])
  @@index([startDate])
  @@index([status])
}

model Instructor {
  id          Int      @id @default(autoincrement())
  firstName   String
  lastName    String
  email       String   @unique
  phone       String?
  bio         String?
  expertise   String?  // domaines d'expertise
  experience  String?  // années d'expérience
  photoUrl    String?
  status      String   @default("active") // active, inactive
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sessions    SessionInstructor[]

  @@index([email])
  @@index([status])
}

model SessionInstructor {
  id           Int            @id @default(autoincrement())
  sessionId    Int
  session      TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  instructorId Int
  instructor   Instructor     @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  role         String         @default("formateur") // formateur, assistant, examinateur
  createdAt    DateTime       @default(now())

  @@unique([sessionId, instructorId])
  @@index([sessionId])
  @@index([instructorId])
}

model Document {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  fileName    String
  filePath    String
  fileSize    Int
  mimeType    String
  formationId Int?
  formation   Formation? @relation(fields: [formationId], references: [id])
  sessionId   Int?
  session     TrainingSession? @relation(fields: [sessionId], references: [id])
  category    String   // syllabus, presentation, exercise, resource, certificate_template
  isPublic    Boolean  @default(false)
  uploadedBy  String?  // user ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([formationId])
  @@index([sessionId])
  @@index([category])
  @@index([isPublic])
}

model Assignment {
  id                Int      @id @default(autoincrement())
  title             String
  description       String
  type              String   // tp, exam, project
  formationId       Int
  formation         Formation @relation(fields: [formationId], references: [id], onDelete: Cascade)
  deadline          DateTime
  maxFileSize       Int      @default(10) // MB
  allowedFileTypes  String   @default("pdf,doc,docx,txt,zip")
  instructions      String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  submissions       Submission[]
  
  @@index([formationId])
  @@index([deadline])
  @@index([type])
}

model Submission {
  id             Int      @id @default(autoincrement())
  assignmentId   Int
  assignment     Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  studentEmail   String
  status         String   @default("submitted") // submitted, graded, returned
  grade          Float?   // 0-20
  feedback       String?
  submittedAt    DateTime @default(now())
  gradedAt       DateTime?
  gradedBy       String?  // admin email
  
  files          SubmissionFile[]
  
  @@index([assignmentId])
  @@index([studentEmail])
  @@index([status])
}

model SubmissionFile {
  id           Int      @id @default(autoincrement())
  submissionId Int
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  name         String
  originalName String
  size         Int
  mimeType     String
  url          String
  uploadedAt   DateTime @default(now())
  
  @@index([submissionId])
}

model Evaluation {
  id            Int      @id @default(autoincrement())
  enrollmentId  Int
  enrollment    Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  sessionId     Int?
  session       TrainingSession? @relation(fields: [sessionId], references: [id])
  formationId   Int
  formation     Formation @relation(fields: [formationId], references: [id])

  // Évaluation globale
  overallRating Int      // 1-5 étoiles
  overallComment String?

  // Évaluation détaillée
  contentRating     Int?     // qualité du contenu
  instructorRating  Int?     // qualité du formateur
  materialRating    Int?     // qualité des supports
  organizationRating Int?    // organisation
  facilityRating    Int?     // locaux/équipements

  // Questions ouvertes
  strengths       String?
  improvements    String?
  recommendations String?

  // Métadonnées
  submittedAt     DateTime @default(now())
  isAnonymous     Boolean  @default(false)

  @@unique([enrollmentId])
  @@index([formationId])
  @@index([sessionId])
  @@index([overallRating])
}

model Payment {
  id            Int       @id @default(autoincrement())
  enrollmentId  Int
  enrollment    Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  amount        Float
  method        String    // card, mobile_money, bank_transfer, cash, check
  status        String    @default("pending") // pending, completed, failed, refunded
  transactionId String?   @unique
  reference     String?   // Référence de paiement
  notes         String?
  paidAt        DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([enrollmentId])
  @@index([status])
  @@index([transactionId])
  @@index([paidAt])
}

model Invoice {
  id            Int       @id @default(autoincrement())
  enrollmentId  Int
  enrollment    Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  invoiceNumber String    @unique
  amount        Float
  taxAmount     Float     @default(0)
  totalAmount   Float
  status        String    @default("draft") // draft, sent, paid, cancelled, overdue
  pdfUrl        String?
  dueDate       DateTime?
  paidDate      DateTime?
  sentAt        DateTime?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([enrollmentId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([dueDate])
}

model Waitlist {
  id          Int      @id @default(autoincrement())
  sessionId   Int
  session     TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  enrollmentId Int
  enrollment  Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  position    Int
  addedAt     DateTime @default(now())
  notifiedAt DateTime?

  @@unique([sessionId, enrollmentId])
  @@index([sessionId])
  @@index([enrollmentId])
  @@index([position])
}

model Attendance {
  id          Int      @id @default(autoincrement())
  sessionId   Int
  session     TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  enrollmentId Int
  enrollment  Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  date        DateTime
  status      String   // present, absent, late, excused
  notes       String?
  recordedAt  DateTime @default(now())
  recordedBy  String?  // user ID

  @@unique([sessionId, enrollmentId, date])
  @@index([sessionId])
  @@index([enrollmentId])
  @@index([date])
  @@index([status])
}
